#@author mochaaP
#@tested mpv:0.32.0-410 mpvnet:5.4.8.0

# === Decoding

priority = high

# ## --- Video

# ### Hardware decoding
hwdec = auto-copy
profile = gpu-hq
gpu-api = d3d11
gpu-shader-cache-dir = "~~/shaders_cache"

fbo-format = auto

# faster 0.5x prescaler https://gist.github.com/bjin/15f307e7a1bdb55842bbb663ee1950ed
# bypasses chroma upscaling for better performance
#glsl-shaders-append="~~/shaders/acme-0.5x.hook"

#vd-lavc-threads = 16 # superthreads

# ### Color correction
icc-3dlut-size = 256x256x256 # default = 64x64x64, delays mpv launch

# ### Interpolation

# https://mpv.io/manual/master/#options-tscale
# https://github.com/mpv-player/mpv/issues/2685
tscale = mitchell

video-sync = display-resample
#video-sync-max-video-change = 5

# ### Dither
dither-size-fruit = 7 # default = 6, delays mpv launch
error-diffusion = burkes

# ### Scale
scale = ewa_lanczossharp

# ### Fixes
# video filters support
hr-seek-framedrop = no
# use mpvSockets instead of fixed value
input-ipc-server = mpvpipe

# fix SVP
no-resume-playback

# enable direct rendering
# large resolution optimizations
vd-lavc-dr = yes
opengl-pbo = yes

# ## --- Audio
ao = wasapi
#audio-exclusive = yes

# ### External
audio-file-auto = fuzzy
#audio-file-paths = audio
alang = 'jpn,ja,eng,en'

#aid = 1 # forces first internal track
# seealso https://github.com/mpv-player/mpv/issues/967#issuecomment-94744964

# ### Fixes
#audio-channels = stereo # force stereo if audio not being played correctly
#audio-normalize-downmix = yes # fixes abnormal volume when mixing multiple tracks

# disabled for VFR
# for autospeedwin (calibrates display refresh rate)
#script-opts = autospeed-nircmd=true,autospeed-speed=false,autospeed-nircmdc="C:\nircmd-x64\nircmdc.exe",autospeed-monitor=0,autospeed-dwidth=1920,autospeed-dheight=1080,autospeed-bdepth=32,autospeed-rates="23;24;25;29;30;50;59;60",autospeed-exitrate=60,autospeed-minspeed=0.9,autospeed-maxspeed=1.1,autospeed-osd=true,autospeed-osdtime=10,autospeed-osdkey=y,autospeed-estfps=false,autospeed-spause=4
# Add `nircmdc.exe` to `PATH` or configure absolute path
# `autospeed-rates="23;24;25;29;30;50;59;60",autospeed-exitrate=60` supported refresh rates and reset when exit. e.g. 23=23.976
# `autospeed-spause=4` autopause interval

# ## --- Image
# don't slideshow by default
image-display-duration=inf
# loop files in case of webms or gifs
loop-file=inf
# and loop the whole playlist
loop-playlist=inf

# === Experiences

# ## --- UI

# ### Input
#input-default-bindings = no
input-ar-delay = 500
input-ar-rate = 20

# ### OSD
osc = no # replaced with thumbnail plugin
osd-duration = 2000
osd-playing-msg = '${filename}'
osd-font = "Inter Medium"
osd-font-size = 36

# ### Window
keep-open = yes
keep-open-pause = no
#window-dragging = no
cursor-autohide = 150

# use ontop-playback.lua to auto-ontop when playing (PIP)
ontop

# ## --- Subtitles

# ### Defaults
sub-font="Noto Serif CJK SC Semibold"
sub-font-size=36
sub-color="#FFFFFFFF"
sub-border-color="#FF262626"
sub-border-size=3.2
sub-shadow-offset=1
sub-shadow-color="#33000000"
sub-spacing=0.5

# ### External
sub-auto = fuzzy
sub-file-paths = sub,subtitles,Subtitles,subs,Subs,字幕
slang = 'chi,zh-CN,sc,chs,zh-HK,zh-TW,tc,cht'
#secondary-sid = 1
#sid = 2

# ### Fixes

#sub-ass-vsfilter-aspect-compat = no # scale subtitles with video
#sub-ass-vsfilter-blur-compat = no # fixes blur
# vsfilter/libass bugs sometimes


# ## --- Screenshots
screenshot-format = png
screenshot-directory = 'C:\Users\mocha\OneDrive\图片\Saved Pictures\mpv'

screenshot-tag-colorspace = yes
#screenshot-png-compression = 0
#screenshot-png-filter = 0

# === Scripts
script-opts = osc-scalewindowed=1.5,osc-hidetimeout=2000,console-scale=1
#scripts-append = '~~/scripts/modules.js'

# === Profiles

# 根据视频是否是HDR以及视频aspect ratio决定是否启用blend-subtitles的profile
# 目前HDR->SDR建议关闭blend-subtitles，见https://github.com/mpv-player/mpv/issues/6368
# 如果hdr-compute-peak将来继续改进可能可以兼容blend-subtitles
# Editor

[HDR_or_21:9]
profile-desc = cond:(p["video-params/primaries"]=="bt.2020" or p["video-params/aspect"]>=2.0)
blend-subtitles = no
# 使字幕输出在黑边上
sub-ass-force-margins = yes

[SDR_and_16:9]
profile-desc = cond:(p["video-params/primaries"]~="bt.2020" and p["video-params/aspect"]<2.0)
blend-subtitles = yes
sub-ass-force-margins = no

[high_quality]
profile = gpu-hq
## !!! 使用  fbo-format=rgba16hf  可能能提高效率
fbo-format = rgba32f
## !!! 使用  fbo-format=rgba16hf  可能能提高效率
vd-lavc-threads = 0

[low]
profile-desc = cond:(p["video-params/w"]<=678 and p["video-params/h"]<=381)
profile = high_quality
glsl-shaders-append = "~~/shaders/KrigBilateral.glsl"
glsl-shaders-append = "~~/shaders/nnedi3-nns32-win8x4.hook"
glsl-shaders-append = "~~/shaders/nnedi3-nns32-win8x4.hook"

[SD]
profile-desc = cond:((p["video-params/w"]<1080 and p["video-params/h"]<608) and (p["video-params/w"]>678 or p["video-params/h"]>381))
profile = high_quality
glsl-shaders-append = "~~/shaders/KrigBilateral.glsl"
glsl-shaders-append = "~~/shaders/nnedi3-nns64-win8x4.hook"

[HD30]
profile-desc = cond:((p["video-params/w"]<1358 and p["video-params/h"]<764) and (p["video-params/w"]>=1080 or p["video-params/h"]>=608) and p["estimated-vf-fps"]<31)
profile = high_quality
glsl-shaders-append = "~~/shaders/KrigBilateral.glsl"
glsl-shaders-append = "~~/shaders/nnedi3-nns32-win8x4.hook"

[HD60]
profile-desc = cond:((p["video-params/w"]<1358 and p["video-params/h"]<764) and (p["video-params/w"]>=1080 or p["video-params/h"]>=608) and p["estimated-vf-fps"]>=31)
profile = high_quality
glsl-shaders-append = "~~/shaders/KrigBilateral.glsl"
glsl-shaders-append = "~~/shaders/SSimSuperRes.glsl"
# SSimSuperRes推荐关闭sigmoid-upscaling。所以在其他不用SSSR的profile中都要重新设为yes（通过重新设定一遍profile=gpu-hq）
sigmoid-upscaling = no

[KrigBilateral]
profile = high_quality
glsl-shaders-append = "~~/shaders/KrigBilateral.glsl"

[FHD]
profile-desc = cond:((p["video-params/w"]<=1920 and p["video-params/h"]<=1080) and (p["video-params/w"]>=1358 or p["video-params/h"]>=764))
profile = KrigBilateral

[2K30]
profile-desc = cond:((p["video-params/w"]<=2560 and p["video-params/h"]<=1440) and (p["video-params/w"]>1920 or p["video-params/h"]>1080) and p["estimated-vf-fps"]<31)
profile = KrigBilateral

[4K30]
profile-desc = cond:((p["video-params/w"]>2560 or p["video-params/h"]>1440) and p["estimated-vf-fps"]<31)
profile = high_quality
glsl-shaders-append = "~~/shaders/SSimDownscaler.glsl"
# SSimDownscaler要求。需要在其他profile中重新设为yes（通过重新设定一遍profile=gpu-hq）
linear-downscaling = no

[UHD60]
profile-desc = cond:((p["video-params/w"]>1920 or p["video-params/h"]>1080) and p["estimated-vf-fps"]>=31)
glsl-shaders-append="~~/shaders/acme-0.5x.hook"
