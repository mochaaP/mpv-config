
#@author mochaaP
#@tested mpv:0.32.0-410 mpvnet:5.4.8.0

############
# Decoding #
############

#priority = high

# --- Video ---

# -> Hardware decoding
hwdec = auto-copy
hwdec-codecs = all
profile = gpu-hq
gpu-api = d3d11
gpu-shader-cache-dir = "~~/shaders_cache"

fbo-format = auto

# faster 0.5x prescaler https://gist.github.com/bjin/15f307e7a1bdb55842bbb663ee1950ed
# bypasses chroma upscaling for better performance
#glsl-shaders-append="~~/shaders/acme-0.5x.hook"

#vd-lavc-threads = 16 # superthreading

# -> Scale
scale = ewa_lanczossharp

scale-antiring=0.7
dscale-antiring=0.7
cscale-antiring=0.7

# -> Interpolation

# https://mpv.io/manual/master/#options-tscale
# https://github.com/mpv-player/mpv/issues/2685
tscale = mitchell

video-sync = display-resample
#video-sync-max-video-change = 5

# disabled for VFR
# for autospeedwin (calibrates display refresh rate)
#script-opts = autospeed-nircmd=true,autospeed-speed=false,autospeed-nircmdc="C:\nircmd-x64\nircmdc.exe",autospeed-monitor=0,autospeed-dwidth=1920,autospeed-dheight=1080,autospeed-bdepth=32,autospeed-rates="23;24;25;29;30;50;59;60",autospeed-exitrate=60,autospeed-minspeed=0.9,autospeed-maxspeed=1.1,autospeed-osd=true,autospeed-osdtime=10,autospeed-osdkey=y,autospeed-estfps=false,autospeed-spause=4
# Add `nircmdc.exe` to `PATH` or configure absolute path
# `autospeed-rates="23;24;25;29;30;50;59;60",autospeed-exitrate=60` supported refresh rates and reset when exit. e.g. 23=23.976
# `autospeed-spause=4` autopause interval

# -> Dither
dither-size-fruit = 7 # default = 6, delays mpv launch
error-diffusion = burkes

# -> Color correction
icc-3dlut-size = 256x256x256 # default = 64x64x64, delays mpv launch

# -> Fixes

# fix SVP

# video filters support
hr-seek-framedrop = no
# use mpvSockets instead of fixed value
input-ipc-server = mpvpipe

# enable direct rendering
# large resolution optimizations
vd-lavc-dr = yes
opengl-pbo = yes

# --- Audio ---
ao = wasapi
#audio-exclusive = yes

# -> External
audio-file-auto = fuzzy
#audio-file-paths = audio
alang = 'jpn,ja,eng,en'

#aid = 1 # forces first internal track
# seealso https://github.com/mpv-player/mpv/issues/967#issuecomment-94744964

# -> Fixes
#audio-channels = stereo # force stereo if audio not being played correctly
#audio-normalize-downmix = yes # fixes abnormal volume when mixing multiple tracks

# --- Image ---
# don't slideshow by default
image-display-duration = inf
# loop files in case of webms or gifs
loop-file = inf
# and loop the whole playlist
loop-playlist = inf

##############
# Experience #
##############

# --- UI ---

# -> Input
#input-default-bindings = no
input-ar-delay = 500
input-ar-rate = 20

# -> OSD
osc = no # replaced with thumbnail plugin
osd-duration = 2000
osd-playing-msg = '▶ ${media-title:filename}'
osd-font = "Inter Medium"
osd-font-size = 36

# -> Window
keep-open = yes
keep-open-pause = no
#window-dragging = no
cursor-autohide = 150

# use ontop-playback.lua to auto-ontop when playing (PIP)
#ontop = yes

# --- Subtitles ---

# -> Default Style
sub-font = 'Noto Serif CJK SC Semibold'
sub-font-size = 36
sub-color = '#FFFFFFFF'
sub-border-color = '#FF262626'
sub-border-size = 3.2
sub-shadow-offset = 1
sub-shadow-color = "#33000000"
sub-spacing = 0.5

# -> External
sub-auto = fuzzy
sub-file-paths = sub,subtitles,字幕,ass,srt
slang = 'chi,zh-CN,sc,chs,zh-HK,zh-TW,tc,cht'
#secondary-sid = 1
#sid = 2

# -> Fixes

# vsfilter/libass bugs
#sub-ass-vsfilter-aspect-compat = no # scale subtitles with video
#sub-ass-vsfilter-blur-compat = no # fixes blur


# --- Screenshots ---
screenshot-format = png
screenshot-directory = 'C:\Users\mocha\OneDrive\图片\Saved Pictures\mpv'

screenshot-tag-colorspace = yes
#screenshot-png-compression = 0
#screenshot-png-filter = 0

###########
# Scripts #
###########

script-opts = osc-scalewindowed=1.5,osc-hidetimeout=2000,console-scale=1
#scripts-append = '~~/scripts/modules.js'

############
# Profiles #
############

# 根据视频是否是HDR以及视频aspect ratio决定是否启用blend-subtitles的profile
# 目前HDR->SDR建议关闭blend-subtitles，见https://github.com/mpv-player/mpv/issues/6368
# 如果hdr-compute-peak将来继续改进可能可以兼容blend-subtitles

[HDR_or_21:9]
profile-desc = cond:(p["video-params/primaries"]=="bt.2020" or p["video-params/aspect"]>=2.0)

blend-subtitles = no
sub-ass-force-margins = yes

[SDR_and_16:9]
profile-desc = cond:(p["video-params/primaries"]~="bt.2020" and p["video-params/aspect"]<2.0)

blend-subtitles = yes
sub-ass-force-margins = no

[high_quality]
profile = gpu-hq
## use rgba16hf for possible fps boost
## for compability use rgba32f(?)
fbo-format = rgba32f

#vd-lavc-threads = 0 # was already done by default

[low]
profile-desc = cond:(p["video-params/w"]<=678 and p["video-params/h"]<=381)

profile = high_quality

glsl-shaders-append = "~~/shaders/KrigBilateral.glsl"
glsl-shaders-append = "~~/shaders/nnedi3-nns32-win8x4.hook"
glsl-shaders-append = "~~/shaders/nnedi3-nns32-win8x4.hook"

[SD]
profile-desc = cond:((p["video-params/w"]<1080 and p["video-params/h"]<608) and (p["video-params/w"]>678 or p["video-params/h"]>381))
profile = high_quality
glsl-shaders-append = "~~/shaders/KrigBilateral.glsl"
glsl-shaders-append = "~~/shaders/nnedi3-nns64-win8x4.hook"

[HD30]
profile-desc = cond:((p["video-params/w"]<1358 and p["video-params/h"]<764) and (p["video-params/w"]>=1080 or p["video-params/h"]>=608) and p["estimated-vf-fps"]<31)
profile = high_quality
glsl-shaders-append = "~~/shaders/KrigBilateral.glsl"
glsl-shaders-append = "~~/shaders/nnedi3-nns32-win8x4.hook"

[HD60]
profile-desc = cond:((p["video-params/w"]<1358 and p["video-params/h"]<764) and (p["video-params/w"]>=1080 or p["video-params/h"]>=608) and p["estimated-vf-fps"]>=31)
profile = high_quality

glsl-shaders-append = "~~/shaders/KrigBilateral.glsl"
glsl-shaders-append = "~~/shaders/SSimSuperRes.glsl"

sigmoid-upscaling = no # SSimSuperRes

[KrigBilateral]
profile = high_quality
glsl-shaders-append = "~~/shaders/KrigBilateral.glsl"

[FHD]
profile-cond = (p["video-params/w"]<=1920 and p["video-params/h"]<=1080) and (p["video-params/w"]>=1358 or p["video-params/h"]>=764)
profile = KrigBilateral

[2K30]
profile-cond = (p["video-params/w"]<=2560 and p["video-params/h"]<=1440) and (p["video-params/w"]>1920 or p["video-params/h"]>1080) and p["estimated-vf-fps"]<31
profile = KrigBilateral

[4K30]
profile-cond = (p["video-params/w"]>2560 or p["video-params/h"]>1440) and p["estimated-vf-fps"]<31
profile = high_quality
glsl-shaders-append = "~~/shaders/SSimDownscaler.glsl"
# for SSimDownscaler
linear-downscaling = no

[UHD60]
profile-cond = (p["video-params/w"]>1920 or p["video-params/h"]>1080) and p["estimated-vf-fps"]>=31
glsl-shaders-append = "~~/shaders/acme-0.5x.hook"

[ytdl]
ytdl-format = bestvideo+bestaudio/best
demuxer-seekable-cache = yes
demuxer-max-bytes = 2048MiB
demuxer-max-back-bytes = 1024MiB
